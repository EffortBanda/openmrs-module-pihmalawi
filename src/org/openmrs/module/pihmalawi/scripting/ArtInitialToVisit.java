package org.openmrs.module.pihmalawi.scripting;

import java.io.FileInputStream;
import java.util.Arrays;
import java.util.List;
import java.util.Properties;

import org.openmrs.Concept;
import org.openmrs.Encounter;
import org.openmrs.EncounterType;
import org.openmrs.Form;
import org.openmrs.Obs;
import org.openmrs.Patient;
import org.openmrs.Person;
import org.openmrs.api.context.Context;

/**
 * One-time script to split up the old initial encounters, which (sometimes)
 * also contained visit information
 */
public class ArtInitialToVisit {

	List<EncounterType> artInitials = null;
	List<EncounterType> artFollowups = null;
	Concept apptDate = null;
	Concept numberArvs;
	Concept weight;
	Concept height;
	private Form artVisitForm;
	private Concept amount;

	public ArtInitialToVisit() {
	}

	public static void main(String[] args) throws Exception {
		// parameters
		String importFile = args[0];
		String openmrsRuntimeProperties = args[1];
		String openmrsUser = args[2];
		String openmrsPw = args[3];

		// properties
		Properties prop = new Properties();
		prop.load(new FileInputStream(openmrsRuntimeProperties));
		String connectionUser = prop.getProperty("connection.username");
		String conncetionPw = prop.getProperty("connection.password");
		String conncetionUrl = prop.getProperty("connection.url");

		// connection init
		Context.startup(conncetionUrl, connectionUser, conncetionPw, prop);
		Context.openSession();
		Context.authenticate(openmrsUser, openmrsPw);

		new ArtInitialToVisit().run();
	}

	public void run() throws Exception {
		artInitials = Arrays.asList(Context.getEncounterService()
				.getEncounterType("ART_INITIAL"));
		artFollowups = Arrays.asList(Context.getEncounterService()
				.getEncounterType("ART_FOLLOWUP"));
		artVisitForm = Context.getFormService().getForm("ART Visit");
		apptDate = Context.getConceptService().getConcept("Appointment date");
		numberArvs = Context.getConceptService().getConcept(
				"NUMBER OF ANTIRETROVIRALS GIVEN");
		weight = Context.getConceptService().getConcept("Weight (kg)");
		height = Context.getConceptService().getConcept("Height (cm)");
		amount = Context.getConceptService().getConcept("AMOUNT OF DRUG BROUGHT TO CLINIC");
		
//		Patient p = Context.getPatientService().getPatient(16817);
//		move(p);

		int i = 0;
		// upper neno patients with identifier_type=4
		// String[] ids = {"15901","15913","15918","15924","15940","15982","15983","15994","16003","16071","16237","16493","16590","16593","16760","16769","16771","16773","16785","16788","16793","16798","16806","16813","16817","16818","16829","16835","16837","16838","16860","16864","16867","16878","16882","16884","16885","16887","16891","16897","16904","16908","16909","16916","16917","16918","16923","16928","16929","16932","16936","16940","16948","16962","16963","16973","16975","16976","16981","17036","17037","17041","17046","17062","17085","17112","17127","17131","17170","17236","17257","17366","17374","17486","17565","17573","17627","17653","17658","17749","17757","17823","17839","17938","17944","18074","18096","18103","18219","18227","18244","18250","18275","18356","18461","18480","18509","18529","18532","18565","18606","18633","18658","18667","18678","18773","18777","18791","18825","18845","18912","18951","19017","19035","19215","19216","19229","19231","19238","19255","19336","19347","19348","19365","19378","19402","19439","19464","19505","19569","19601","19616","19650","19730","19759","19844","19870","19880","19903","19926","19929","19955","20083","20096","20243","20333","20334","20351","20352","20367","20377","20403","20448","20475","20485","20520","20538","20568","20573","20689","20723","20863","20965","21019","21115","21116","21118","21140","21142","21174","21249","21261","21264","21331","21335","21465","21483","21507","21561","21568","21605","21634","21653","21683","21715","21734","21770","21778","21804","21847","21896","21924","21926","21927","21980","22034","22065","22103","22107","22205","22210","22253","22264","22271","22292","22351","22352","22525","22539","22551","22567","22590","22596","22659","22698","22747","22751","22773","22863","22876","22934","22935","22977","23025","23090","23101","23106","23199","23227","23253","23446","23449","23455","23473","23490","23494","23537","23546","23561","23580","23595","23617","23625","23629","23638","23700","23774","23812","23834","23837","23839","23840","23876","23879","23887","23912","23953","24005","24007","24014","24087","24115","24174","24202","24206","24221","24244","24278","24281","24343","24421","24537","24551","24567","24595","24609","24628","24630","24634","24667","24671","24809","24820","24821","24843","24856","24907","25004","25005","25024","25029","25031","25091","25204","25251","25318","25319","25326","25327","25328","25345","25356","25407","25504","25627","25707","25729","25792","25858","25911","25965","25982","25984","26025","26090","26128","26131","26144","26163","26203","26221","26246","26261","26278","26338","26352","26374","26397","26402","26443","26529","26628","26638","26646","26668","26676","26707","26712","26721","26724","26761","26773","26989","27009","27102","27175","27186","27191","27207","27226","27228","27345","27366","27378","27649","27803","27817","27823","27874","27994","28007","28076","28143","28253","28270","28286","28491","28643","28806","28816","28820","28852","28856","28935","28942","28943","29037","29044","29059","29290","29409","29513","29584","29660","29709","29710","29742","29808","29891","29961","30017","30028","30197","30267","30289","30427","30568","30656","30688","30725","30968","30987","31012","31056","31116","31137","31196","31382","31470","31571","31615","31641","31743","31754","31871","31946","32125","32141","32159","32188","32204","32205","32255","32271","32302","32315","32337","32394","32397","32468","32495","32584","32623","32649","32653","32880","32892","32969","33183","33229","33254","33265","33422","33428","33429","33431","33436","33443","33596","33630","33659","33680","33752","33824","33870","33900","33906","33924","33982","34064","34090","34111","34128","34190","34236","34245","34248","34249","34269","34281","34367","34390","34453","34614","34631","34646","34675","34680","34688","34696","34707","34724","34776","34792","34834","34873","34875","34942","35042","35097","35100","35116","35233","35240","35245","35345","35397","35440","35454","35496","35527","35585","35635","35655","35673","35723","35933","35978","35985","35988","35989","36006","36030","36075","36161","36190","36374","36377","36465","36480","36559","36573","36600","36615","36620","36631","36643","36708","36813","36818","36842","36851","36855","36976","36977","36981","37067","37092","37104","37110","37116","37234","37250","37252","37269","37344","37376","37377","37422","37449","37535","37650","37656","37670","37690","37747","37850","37870","37904","37908","37910","38015","38128","38156","38181","38314","38349","38365","38377","38427","38435","38448","38482","38580","38656","38659","38749","38751","38781","38792","38806","38829","38844","39020","39028","39046","39047","39088","39308","39342","39427","39458","39481","39586","39608","39789","39807","39811","39840","39843","39853","39892","39895","39906","39935","39955","40056","40063","40097","40101","40171","40360","40365","40392","40429","40502","40539","40636","40703","40709","40735","40736","40893","40995","40998","41032","41038","41040","41048","41060","41088","41129","41130","41134","41148","41173","41250","41253","41290","41315","41319","41338","41386","41408","41498","41551","41635","41641","41751","41754","41767","41836","41841","41858","42131","42138","42140","42141","42247","42261","42316","42415","42417","42471","42572","42573","42575","42595","42739","42740","43018","43063","43064","43083","43104","43117","43137","43142","43167","43201","43234","43380","43411","43666","43682","43813","43815","43867","43871","43896","43898","43999","44067","44090","44098","44104","44145","44179","44272","44302","44326","44340","44342","44347","44395","44475","44481","44548","44589","44862","44867","44903","44961","45076","45087","45088","45173","45215","45237","45248","45254","45426","45452","45600","45831","45907","46095","46098","46115","46125","46129","46155","46398","46415","46545","46604","46654","46672","46690","46730","46867","46874","46927","46963","47064","47119","47121","47151","47239","47260","47496","47500","47502","47564","47595","47783","47871","47895","47909","47957","48009","48099","48159","48268","48302","48318","48369","48378","48379","48429","48431","48481","48505","48551","48571","48573","48670","48726","48897","48899","48905","48935","48961","48962","48986","48992","49001","49005","49022","49032","49033","49105","49162","49163","49231","49260","49264","49319","49386","49412","49444","49462","49472","49532","49606","49651","49658","49725","49746","49778","49808","49834","49845","49847","49892","49894","49940","49960","49986","50023","50121","50124","50130","50158","50191","50219","50220","50233","50266","50270","50331","50412","50464","50470","50521","50557","50593","50595","50642","50651","50652","50877","50893","50996","51011","51033","51053","51058","51080","51113","51114","51117","51118","51121","51126","51137","51145","51160","51215","51307","51334","51338","51344","51352","51353","51360","51364","51366","51380","51395","51415","51470","51472","51555","51644","51693","51794","51796","51831","51844","51942","51953","51980","51984","51985","51986","51988","51991","52041","52075","52145","52186","52308","52311","52348","52349","52384","52402","52429","52433","52435","52442","52480","52481","52492","52622","52674","52719","52756","52796","52840","52885","52905","52933","52941","52986","53013","53014","53138","53197","53213","53215","53285","53286","53314","53358","53422","53492","53554","53555","53559","53601","53602","53603","53605","53682","53716","53723","53741","53758","53836","53912","53982","54029","54043","54101","54104","54208","54210","54280","54282","54379","54382","54440","54446","54519","54544","54572","54577","54596","54612","54747","54748","54771","54893","54916","54951","54969","55022","55032","55039","55174","55175","55177","55216","55230","55270","55272","55294","55374","55409","55431","55476","55479","55501","55511","55512","55552","55558","55563","55611","55696","55726","55807","55811","55812","55816","55828","55847","55913","55920","55921","55922","55931","55932","55938","55940","55943","55945","56007","56013","56014","56044","56046","56081","56083","56096","56101","56248","56378","56432","56553","56554","56561","56592","56593","56594","56595","56609","56682","56704","56707","56708","56712"};
		// lower neno patients with identifier_type=4
		String[] ids = {"17194","17195","17196","17197","17198","17199","17200","17201","17202","17203","17204","17205","17206","17207","17208","17210","17211","17212","17213","17214","17215","17216","17217","17218","17219","17220","17221","17222","17223","17224","17225","17226","17227","17228","17229","17230","17231","17232","17233","17234","17235","17236","17237","17238","17239","17240","17241","17242","17243","17244","17245","17246","17247","17248","17249","17250","17251","17252","17253","17254","17255","17256","17257","17258","17259","17260","17261","17262","17263","17264","17265","17268","17269","17270","17271","17272","17273","17274","17275","17276","17277","17278","17279","17280","17281","17282","17283","17284","17285","17287","17288","17289","17290","17291","17292","17293","17294","17295","17296","17297","17298","17299","17300","17301","17302","17303","17304","17305","17306","17307","17308","17309","17310","17312","17313","17314","17315","17316","17317","17318","17319","17320","17321","17322","17323","17324","17325","17326","17327","17328","17329","17330","17331","17332","17333","17334","17335","17336","17337","17338","17339","17340","17341","17342","17343","17344","17345","17346","17347","17348","17349","17350","17351","17352","17353","17354","17355","17356","17357","17358","17360","17361","17362","17364","17365","17366","17367","17368","17369","17370","17371","17372","17373","17374","17375","17376","17377","17379","17380","17381","17382","17383","17384","17385","17386","17387","17388","17389","17392","17393","17394","17395","17396","17397","17398","17399","17400","17401","17402","17403","17404","17405","17406","17407","17408","17409","17410","17411","17412","17413","17414","17415","17416","17417","17418","17419","17420","17421","17422","17423","17424","17425","17426","17427","17428","17429","17431","17432","17433","17434","17435","17436","17437","17438","17439","17440","17441","17442","17443","17444","17445","17447","17448","17450","17451","17452","17453","17454","17456","17457","17459","17460","17461","17462","17463","17464","17465","17466","17467","17468","17469","17471","17472","17473","17474","17475","17476","17477","17478","17479","17480","17481","17482","17483","17484","17485","17486","17487","17488","17489","17490","17491","17492","17493","17494","17495","17496","17497","17498","17499","17500","17501","17502","17503","17504","17506","17507","17508","17510","17512","17513","17514","17515","17516","17517","17518","17519","17520","17521","17522","17523","17524","17525","17526","17527","17528","17529","17530","17531","17532","17533","17534","17535","17536","17537","17538","17539","17540","17541","17542","17543","17544","17545","17546","17547","17548","17549","17550","17552","17553","17554","17555","17556","17557","17558","17559","17562","17563","17564","17566","17567","17568","17569","17570","17571","17573","17574","17575","17576","17577","17578","17579","17580","17581","17582","17583","17584","17585","17586","17587","17588","17589","17590","17591","17592","17593","17594","17595","17596","17597","17598","17599","17601","17602","17603","17604","17605","17606","17607","17608","17609","17610","17611","17686","17690","17691","17692","17693","17694","17695","17696","17697","17698","17699","17700","17701","17702","17703","17704","17705","17706","17707","17708","17709","17710","17711","17712","17713","17714","17715","17716","17717","17718","17719","17720","17721","17722","17723","17724","17725","17726","17727","17729","17731","17733","17734","17735","17736","17737","17741","17744","17745","17747","17749","17752","17753","17754","17755","17756","17757","17758","17759","17760","17761","17762","17763","17765","17766","17767","17768","17769","17771","17773","17775","17776","17777","17778","17779","17781","17782","17783","17784","17785","17786","17788","17789","17798","17800","17802","17803","17804","17805","17812","17813","17814","17815","17816","17817","17818","17821","17822","17823","17824","17825","17826","17827","17828","17829","17831","17832","17833","17834","17835","17836","17838","17839","17840","17841","17842","17843","17844","17845","17847","17848","17850","17851","17853","17854","17857","17858","17860","17865","17870","17872","17875","17886","17890","17910","17911","17915","17919","17919","17920","17921","17922","17923","17924","17925","17927","17930","17931","17933","17934","17938","17948","17952","17953","17955","17957","17959","17960","17967","17968","17969","17970","17971","17972","17973","17975","17976","17979","17980","17981","17982","17983","17984","17985","17986","17987","17988","17989","17990","17991","17992","17993","17994","17995","17996","17997","17998","18000","18001","18002","18005","18006","18009","18012","18015","18019","18020","18021","18024","18025","18026","18027","18028","18029","18030","18031","18032","18033","18034","18035","18036","18037","18038","18039","18040","18041","18042","18043","18044","18045","18046","18047","18048","18049","18051","18052","18053","18054","18055","18056","18057","18058","18059","18060","18061","18062","18063","18064","18065","18066","18067","18068","18069","18071","18078","18083","18084","18100","18102","18104","18106","18107","18108","18109","18110","18111","18113","18116","18117","18118","18119","18120","18121","18122","18124","18125","18131","18133","18134","18135","18136","18137","18138","18139","18140","18143","18145","18147","18149","18150","18151","18152","18153","18154","18155","18156","18157","18158","18159","18160","18161","18162","18163","18164","18165","18166","18167","18168","18169","18170","18171","18172","18173","18174","18175","18176","18177","18178","18179","18180","18181","18182","18183","18184","18185","18186","18187","18188","18189","18190","18191","18192","18193","18194","18195","18196","18197","18198","18199","18200","18207","18208","18209","18210","18211","18212","18213","18214","18215","18216","18217","18221","18222","18223","18224","18225","18226","18227","18228","18229","18230","18231","18233","18234","18235","18236","18237","18238","18239","18240","18241","18242","18243","18244","18245","18246","18247","18248","18249","18250","18251","18252","18253","18254","18255","18256","18257","18258","18259","18260","18261","18262","18263","18264","18265","18266","18267","18269","18270","18271","18272","18273","18274","18275","18276","18281","18282","18283","18284","18285","18286","18287","18288","18289","18290","18291","18292","18293","18294","18295","18296","18297","18300","18301","18302","18306","18307","18308","18309","18313","18316","18317","18318","18320","18321","18322","18326","18327","18328","18331","18345","18346","18348","18349","18350","18351","18352","18353","18354","18355","18356","18359","18361","18362","18363","18364","18365","18366","18378","18379","18388","18389","18390","18391","18392","18393","18395","18396","18397","18405","18409","18417","18418","18419","18420","18421","18426","18427","18431","18432","18435","18452","18459","18460","18461","18462","18463","18464","18465","18466","18468","18470","18471","18472","18473","18474","18477","18479","18480","18481","18482","18483","18484","18501","18503","18505","18506","18510","18517","18532","18554","18564","18623","18624","18625","18628","18631","18638","18639","18643","18644","18645","18646","18647","18655","18657","18665","18669","18681","18685","18691","18692","18693","18694","18696","18708","18710","18713","18715","18718","18720","18721","18724","18727","18730","18731","18734","18740","18741","18743","18744","18745","18759","18760","18762","18765","18766","18770","18773","18775","18810","18811","18812","18815","18823","18824","18825","18826","18827","18828","18829","18830","18831","18837","18838","18848","18855","18867","18869","18872","18874","18876","18877","18883","18884","18885","18887","18888","18890","18891","18893","18897","18898","18899","18901","18903","18904","18905","18906","18908","18909","18910","18911","18912","18913","18919","18920","18923","18925","18927","18928","18930","18931","18932","18943","18949","18954","18955","18957","18958","18959","18960","18966","18967","18972","18983","18985","18987","18988","18989","18994","19015","19016","19017","19025","19030","19031","19032","19040","19041","19042","19043","19044","19045","19046","19047","19048","19051","19072","19073","19074","19075","19076","19077","19078","19079","19080","19081","19082","19085","19087","19089","19093","19098","19099","19104","19112","19113","19114","19115","19116","19145","19146","19147","19149","19164","19168","19171","19172","19173","19174","19175","19179","19180","19181","19183","19186","19187","19188","19192","19193","19199","19203","19205","19206","19207","19208","19209","19211","19219","19220","19221","19223","19225","19226","19227","19241","19242","19243","19244","19247","19250","19276","19409","19412","19417","19422","19425","19426","19432","19434","19438","19453","19454","19455","19456","19461","19462","19466","19467","19469","19475","19484","19487","19499","19502","19503","19505","19514","19518","19540","19541","19542","19548","19549","19550","19551","19552","19553","19554","19555","19599","19600","19604","19605","19613","19619","19620","19621","19625","19626","19632","19633","19649","19651","19655","19683","19684","19691","19692","19693","19694","19707","19709","19710","19727","19742","19752","18583","19766","17978","18549","19774","17791","18013","19783","19784","19471","19788","18612","19789","19790","19714","19134","19491","19228","19718","19723","19754","19791","19792","19793","19794","19797","19799","19166","17898","19239","19803","18726","19486","17868","19065","19436","19734","19424","19804","19805","17801","17790","19201","19806","19191","19821","19830","19837","19838","19839","19841","19685","19859","19861","19862","19863","19478","19860","19200","19202","19165","19057","19433","19435","19485","19430","19136","19497","19616","19617","19494","19611","19612","19144","18847","18982","19867","19868","19869","19870","19871","19872","19873","18968","19874","19875","19615","19882","19822","18376","19842","19885","19895","19896","19473","19732","19912","19913","19856","19881","19918","19919","19750","19771","19920","19923","17866","18103","17794","19933","17806","17856","17855","17750","17748","19884","18975","18491","18974","17871","18997","19488","19736","18478","17888","18330","19940","19904","19943","19944","19945","19826","17863","19948","19949","17908","19744","19769","17893","19825","18697","19712","19719","18329","18991","17751","17622","17796","17739","17728","17797","17795","17774","17743","17807","17810","17861","18114","18115","19886","17730","17764","17770","18500","17878","19716","18112","19717","18394","18391","17509","18680","19768","19677","19708","17897","19969","17873","18475","19148","19887","19970","19063","18206","17793","19971","19973","18852","19232","18853","18996","19974","19977","19978","19982","19773","19914","19900","19902","20021","18880","20024","19836","19470","20030","20031","20033","19795","20036","18525","20039","20042","20043","18304","20044","19730","20045","19965","20046","20048","20050","19999","20051","19983","20052","19985","17859","17811","20053","20077","18632","18556","19444","20085","20088","20089","19680","20096","20098","19280","20109","18596","20113","20119","20125","19892","19515","19705","20126","20127","18984","17551","18497","19676","19654","20128","20129","20130","17740","19137","19111","19720","20134","20138","18978","20147","20150","17820","20152","20153","20154","20158","20159","19110","17954","19775","19753","19084","17966","20168","20170","20174","20185","20186","20187","17792","18101","18999","18843","19452","19235","20198","20200","18627","20204","20207","20208","20209","20223","20227","20228","20229","20231","20232","18412","20233","20234","20235","20236","20237","20238","20239","19981","20241","20242","17455","20244","20245","18839","20246","20247","20248","17895","17738","20250","20251","20131","20254","19853","20257","20259","20260","20262","19551","19087","19179","17773","18134","17996","18484","18316","18309","18815","19471","18005","18139","18354","19211","19691","19753","20174","20096","19470","20268","18465","20269","19469","17694","18397","19462","18419","19554","17717","17725","18147","19207","18269","17720","18638","19692","19467","20030","18874","19082","17724","18708","20270","20272","20273","20274","20276","17601","19209","19783","18471","18013","18133","19549","20282","20284","20285","20286","20287","20144","20064","20288","20137","20290","20291","19271","20294","17901","18194","19817","19901","20308","20309","20206","19852","20310","18594","20311","19208","17701","18140","18308","17760","17603","17713","18639","18811","18824","17768","17706","19085","17554","18135","17721","17769","20313","20315","18307","17253","17714","17708","17360","17333","20314","20318","20319","19731","20320","20252","20321","20322","20094","19441","17741","18968","19425","20051","19723","18502","20287","19424","19032","19172","17734","17502","18989","20052","17592","19871","19870","20245","19716","20291","17875","17729","19494","20326","18206","17927","19719","19144","20260","19654","19191","18108","18837","20288","17432","20144","20294","17788","17374","17239","20138","17747","18497","20145","18796","19721","19970","19999","19271","17699","17698","17716","17707","19632","20098","18294","18982","20328","19193","20150","17858","19228","20286","17872","17208","17803","17911","18983","19202","20257","20137","20248","19981","19806","17766","18102","17739","17408","17910","19200","17480","17865","18297","19867","20285","20290","19613","18984","17434","17930","17789","19712","18986","18326","17740","19744","18730","17897","20244","20147","20064","19720","17580","19655","20284","17312","19232","20330","20331","20332","18370","20333","20334","20335","20336","20337","20338","18011","18810","20031","17723","17765","20177","17719","17704","19836","18464","19552","19019","18792","20101","19183","17718","19555","19017","20339","20340","17894","20341","20342","20343","18074","20344","20345","20349","20350","20351","20352","17998","17705","18462","18002","17505","17995","17775","18482","17599","19025","19461","20354","20355","20356","18843","19982","17567","17309","20298","17901","19137","18912","17552","19616","17568","18836","17530","17411","20357","20242","20358","18330","20359","19235","20360","17808","17779","18103","18122","17237","18998","17811","19803","18328","18974","19615","17888","20128","19978","20152","19884","19872","18101","19736","18702","20363","17866","20364","20129","17369","20365","19805","17493","20071","20366","17794","20055","17802","19874","20373","20374","20375","20376","18946","20378","20379","20380","20381","20382","20384","17781","17468","20392","18000","17710","19181","17711","20393","19026","19772","20397","19917","20388","20281","20395","20401","20402","18313","18474","19653","17456","19617","17863","17790","17220","18442","20403","19973","18131","19063","20053","19136","18853","18697","19057","20200","19491","18390","17878","17435","18996","19192","17433","19868","20134","17895","19887","18100","17807","17349","17752","19148","18392","17551","18987","17759","17812","17222","17452","17727","17730","19146","17376","18112","18967","19287","19432","17813","19134","17557","19433","17797","18963","20408","19656","17931","20416","20102","19786","20418","20435","20436","20369","20438","20437","20439","20390","20239","19033","18389","17771","18463","17696","18877","17778","19784","18823","20443","20444","20445","18872","20153","19180","17770","17801","18078","17581","19436","17898","17968","18848","20446","17777","17753","17310","20447","17793","20448","17764","19873","20449","19201","20450","19488","17238","17893","19878","18347","18347","18994","17908","19065","19974","19971","17501","18491","17305","19612","19886","20198","19434","19169","20454","20456","19869","18332","19876","17994","19279","19693","20458","20460","18477","17700","20172","20463","18415","20220","18272","18356","20464","20465","18818","20477","20478","20479","20480","20481","20482","20483","20486","20504","20505","17536","18476","20247","19435","17731","19047","20241","19430","17873","18858","19165","20151","18839","18838","17738","19977","17414","17796","17482","17857","17460","17454","20246","17806","17758","19239","17455","20146","19220","20517","20519","18475","20520","20521","20522","18394","19830","20523","20524","20525","20526","20527","20528","20529","20531","20532","20538","20539","20541","20545","17838","19770","20546","20547","20548","18978","18997","18999","20293","17804","17805","17487","20555","17792","20556","20557","18261","20394","17750","17748","17296","17489","19104","17798","18975","18190","17855","19452","17757","17439","17871","18727","18726","17856","20567","20568","20191","20570","20571","20572","20573","20574","20575","17712","19694","18355","18940","18119","17847","20580","18478","18118","19486","19499","20583","20584","20585","20586","20587","20588","20589","20590","20591","17481","17782","17743","20605","17541","17735","17761","20612","20615","19219","17762","18273","18826","19985","17538","17531","17791","17774","18669","17529","17783","17751","17241","17733","19717","17375","17859","17622","18331","17524","20619","20620","20225","20622","20625","19711","20627","20628","20629","20630","18271","17504","17410","17715","20631","18869","17576","18143","20170","17997","18931","20637","20638","20639","20640","20261","20649","20650","20651","20653","20122","20655","20658","20659","20660","20663","20664","20665","20669","20670","20635","20671","20374","20673","20674","20675","20677","20065","20678","20682","20689","20692","20694","19911","20695","20696","19010","20699","20709","18847","20710","20713","20714","20715","20716","20717","20718","20719","18368","17767","17874","19084","20168","20726","20727","20728","20729","20730","20731","18700","20734","18012","18932","18366","17784","19493","20737","20738","20746","20748","20626","20204","18393","18502","18505","18469","17894","20312","18488","18413","17808","18388","20747","20762","20772","20773","20775","20776","20777","20778","20779","20781","20706","20579","20782","20783","20784","20785","20786","20787","20029","20029","19018","19018","19910","19910","20788","19054","19054","20109","20104","20104","20789","20169","20169","19721","20445","19276","18998","20790","18001","20791","17886","19199","19189","20793","19443","20796","20797","20807","20633","18667","20808","20809","20822","20825","20828","20834","20837","20838","20839","20851","20852","20756","20853","19876","20854","20857","20858","20859","20175","20681","20870","20871","20875","20876","20877","20878","20385","20881","20882","20889","20890","19854","20893","20501","20894","20895","20896","17864","20897","20693","20898","20899","20900","20901","20902","20903","20552","20793","20919","20415","20920","20922","19690","18080","20927","20180","20831","20934","20855","20938","20939","20566","20943","20957","20958","20959","20960","20511","20687","20962","20407","18099","20966","20967","20968","20179","20970","20680","18483","20977","20944","20978","18582","20983","18558","20989","20992","20993","20994","20995","20951","21001","21002","20981","21004","21005","21008","18995","18995","20810","21010","19035","20964","21013","20652","21028","21030","21031","20972","21032","20904","21035","21040","20987","21041","21045","21046","21048","21049","21052","20940","21054","21055","21060","20576","21061","21063","21064","21066","21067","21068","20950","21071","21073","21076","21077","21078","20799","21086","21099","19474","19726","21104","21105","20985","21120","21123","20146","20555","21133","21134","21108","21137","21144","21147","21148","21149","21084","21150","21151","21154","21181","21182","21184","20744","21185","21186","19991","21187","21188","21192","21193","21194","21195","21196","21103","18629","21199","20925","21143","21216","21217","21218","21219","21220","21221","19934","21222","21239","19787","21240","21241","20173","21245","21249","21250","21252","21257","20764","21260","21111","20910","20910","21261","21262","21263","21264","21265","21139","21266","21267","21008","21273","21274","21287","21091","21232","21246","21296","21297","21298","19963","21304","21309","19697","21312","21313","21316","21247","21320","20818","21322","21323","21324","21180","21180","20705","18582","21339","19097","18509","21330","21343","21198","21276","21366","21367","21116","21319","21377","21378","21226","21106","21396","21398","19905","21399","21277","18516","20921","21406","21408","21413","21420","21423","21342","21425","21426","21427","21332","19352","21430","21440","21441","21445","19036","21456","21457","21190","21329","21458","21459","20780","17907","21461","21251","21469","21470","21471","21433","21475","17819","21478","21479","21482","21489","21490","21315","19740","19014","21498","17378","17378","20553","21510","21511","21512","20998","21448","21515","21200","21432","21519","21520","21215","18611","21528","20885","21533","21444","21508","21534","21535","21536","21537","21538","20979","21542","21543","21544","21545","21436","21394","21549","21550","21493","21558","21559","19437","19437","21570","21572","21579","21580","20980","21581","19061","21462","20613","21582","21400","21101","21102","21590","21591","21592","19778","21596","21597","20667","21599","21600","21607","21608","21327","21610","21613","21555","17286","21616","21617","21618","21504","18508","21626","21631","20731","20890","20889","19793","17365","18955","21077","20355","21182","18284","19242","17330","19769","21002","18227","21049","21123","18583","18908","21377","19903","19903","21470","21091","18963","17823","21469","17356","19605","18893","17426","18217","17351","17510","18270","21078","21076","20047","20047","17467","21319","19948","21648","21650","21651","21652","21646","21654","21292","20777","17971","18196","18714","20728","19223","20831","17453","19754","19853","21607","21328","21192","21327","17450","21264","21575","21675","21676","21677","19697","17452","21068","21427","18680","21420","19186","21515","21220","21181","19727","21572","21061","21408","21599","21323","20818","21678","18688","19731","21312","20050","21378","21598","21680","21306","20263","21687","21278","21690","21695","20266","20779","20566","20312","17295","17394","17442","20730","21221","20320","19900","18700","18505","20273","17988","20898","21700","21701","21709","20518","21551","20133","21710","21711","19722","21146","21713","21561","19979","21714","19161","21715","19055","17836","20548","18061","20716","20262","21519","20719","17547","21028","21261","21475","18047","20950","21536","19026","20272","20727","20223","21199","18169","21429","19943","21535","21537","21478","17366","20620","21001","20158","20336","19076","21445","20979","17423","18301","21139","21538","19474","20349","19099","21048","20943","20334","18157","19036","18066","20254","21052","20209","17345","17819","21249","20043","21144","20531","17287","18954","19518","17851","21459","18110","18532","20839","18427","21545","19854","18039","20980","21366","21324","21580","20094","18060","18062","20444","17923","18183","20384","21041","19726","17816","20231","21579","21367","17979","21573","21716","21717","18672","20750","21468","20893","21448","18041","20180","19800","19800","21471","18594","20160","18040","19072","19073","19912","18160","20635","21287","17490","21722","18033","17461","19619","20186","21263","19768","20460","20525","19913","19115","21723","18596","18596","18080","21400","21730","21673","21731","21732","21322","18166","21226","21570","17216","18216","18109","18321","21534","21733","20733","21753","19866","19866","21758","21759","20265","21760","21761","21762","21255","21514","17415","17542","20501","21430","21639","21767","21768","21769","21228","21638","20930","21770","21432","21468","17357","18713","20274","18624","21772","18304","18096","18096","21544","17275","21232","21452","21591","21433","17373","20333","18920","21773","20523","19851","17424","18225","20900","21774","21775","21776","21343","17975","21777","17838","20772","17479","18556","21778","20669","20546","18020","21407","21407","21292","21029","21029","19287","17595","18178","19599","19923","20232","17591","20251","21779","21137","21267","21060","19901","18461","18195","19625","17298","17596","18694","21600","18612","19788","17585","17422","17318","17841","18902","18480","20191","19541","18897","18164","18198","20586","19896","17431","20978","20588","20587","17230","20977","18514","21135","20084","17610","17586","17496","20904","21608","21780","17990","21257","18760","17512","18186","19206","18231","21329","19708","21781","21782","21208","21208","18623","20225","20309","20579","21783","21784","21785","21786","21072","18340","21562","18689","21797","21798","21799","18790","21800","21696","20421","21802","21686","21689","19021","21803","21804","19949","17728","18359","17934","18293","18345","20085","17865","18111","18154","18117","19514","17283","17412","18180","20762","18068","17340","17263","18229","17829","20528","18549","17523","17368","18176","17332","21806","21807","18431","21455","18911","18421","19892","18765","17457","17608","18644","17427","18250","19710","21095","21604","21012","20948","18914","19941","21603","21811","21812","21352","20544","21107","21813","19908","21814","19216","21145","21816","21507","21380","20817","21820","21821","21301","21452","21772","21723","20111","21822","21823","18541","21831","21832","21833","18629","18930","18136","18136","19116","21837","21838","21472","21839","21840","17853","18831","18888","21844","21845","19863","18238","21634","17602","19074","20343","18161","21846","21848","21862","21863","20836","21864","21865","18956","18956","21866","21867","21868","18489","18489","19714","19715","19715","17772","17772","17780","17780","20143","20143","18504","18504","18105","18105","18971","18971","17540","18319","18319","18268","18268","19160","19160","19487","19713","19713","17732","17732","17877","17877","18476","19204","19204","17929","17929","17449","17449","17267","17267","19190","19190","20599","17899","21620","21874","21875","20370","17809","17809","21881","21882","21883","21884","17861","17861","21885","21886","21888","21889","21890","21891","21892","21893","21509","21894","17600","17600","18232","18232","17391","17391","18050","18050","18023","18023","18695","18695","18298","18298","18070","18070","18022","18022","18774","18774","20569","20569","20459","20459","21454","21657","21571","21571","19109","19109","21446","18197","21896","21652","21320","19352","21902","21079","21903","18156","19651","17451","20901","20892","20892","20837","17978","18960","20981","20511","18420","17254","18435","18171","17251","20589","19732","18632","17341","20125","21313","17868","17868","17915","17915","20229","19826","20045","20184","21422","20715","20759","20759","21913","21375","21213","21914","21915","20024","17830","17830","17390","17390","19798","19798","17209","17209","19410","19410","17926","17926","17926","20621","20621","17837","17837","21271","21271","19627","19627","21919","17943","21897","17565","17565","18889","18889","19922","19922","17359","17359","17470","17470","20765","21920","21437","17957","20206","18287","17544","19711","17260","18625","20237","18370","20187","17277","17429","20726","17248","20962","21289","21406","21067","19409","20653","20636","17579","19221","18706","18706","18706","21356","19473","20717","21928","21929","21930","21358","20645","20327","21931","21932","18970","21933","21935","21936","21937","20009","19670","19706","19706","17511","17511","18945","18945","17363","17363","18690","18690","21574","21674","21946","21725","19681","21952","17852","20542","21956","21957","19852","18363","17543","21965","17326","21966","21477","21969","21605","20929","21721","21473","21972","20990","21978","20708","20266","21979","21980","20189","20189","17286","20814","21347","20861","19215","19086","21429","21982","21225","20305","20305","17677","17677","17677","21984","21985","21183","21183","21986","20091","19966","18618","21386","21987","21989","18956","17846","17846","21843","21948","21991","18141","21443","21996","21481","22007","22011","19959","22015","21853","20067","20058","19936","21495","20347","22017","18970","18970","21859","19286","21738","22018","21088","20803","22024","22025","22026","22027","19759","21870","17458","20440","22031","22032","22033","18616","17940","21117","22034","18767","21834","21899","21447","21663","22035","18941","20860","22041","18402","22042","19188","18631","19998","22043","21346","20749","21776","21782","20909","22044","18299","19897","20755","21368","22032","21059","22045","22046","22047","21665","20928","22055","18467","18467","21771","22061","21434","21414","19411","21900","21922","20953","21841","17266","17266","21729","21259","22064","22065","17815","21934","21904","21243","22067","21977","17956","22068","21734","19100","18437","19780","22069","22070","22003","22072","22073","22074","22075","21205","22078","22081","22082","21916","21918","17484","17484","18396","17458","20527","20671","18942","17278","18425","21383","22083","21338","21338","21338","21390","19883","19883","22087","22088","22089","19954","20249","20249","21791","21361","21795","19614","22092","21393","22093","21854","17887","17742","17742","21563","20135","20135","21741","21360","21744","22095","22090","22096","22097","22098","21612","21742","21856","22091","21740","22028","17787","17787","22010"};
		for (String id : ids) {
			System.out.println("Process " + i++ + "/" + ids.length);
			Patient p2 = Context.getPatientService().getPatient(new Integer(id));
			if (p2.isPersonVoided()  || p2.isVoided()) {
				System.out.println("Patient/Person voided, skip it");
			} else {
				move(p2);
			}
		}
	}

	private void move(Patient p) {

		List<Encounter> el = Context.getEncounterService().getEncounters(p,
				null, null, null, null, artInitials, null, false);
		for (Encounter e : el) {
			List<Obs> os = Context.getObsService().getObservations(
					Arrays.asList((Person) p), Arrays.asList(e),
					Arrays.asList(apptDate), null, null, null, null, null,
					null, null, null, false);
			if (!os.isEmpty()) {
				// initial encounter with appt date exist; assuming visit
				// information in initial encounter
				List<Encounter> el2 = Context.getEncounterService()
						.getEncounters(p, null, e.getEncounterDatetime(),
								e.getEncounterDatetime(), null, artFollowups,
								null, false);
				if (el2.isEmpty()) {
					// no matching followup exists, create followup from initial
					createFollowupFromInitial(e);
				} else {
					System.out
							.println(p.getId()
									+ "\tAlready found follow up visit on same day as initial, ignore it.");
				}
			}
		}

	}

	private void createFollowupFromInitial(Encounter i) {
		System.out
				.println(i.getPatientId()
						+ "\tNo follow up visit found on same day as initial, create it.");

		Encounter f = createEncounter(i, Context.getEncounterService()
				.getEncounterType("ART_FOLLOWUP"));
		f.addObs(createObs(obs(i, apptDate)));
		f.addObs(createObs(obs(i, height)));
		f.addObs(createObs(obs(i, weight)));
		f.addObs(createObs(obs(i, numberArvs)));
		f.setForm(artVisitForm);
		Context.getEncounterService().saveEncounter(f);
	}

	private Obs obs(Encounter e, Concept concept) {
		List<Obs> os = Context.getObsService().getObservations(null,
				Arrays.asList(e), Arrays.asList(concept), null, null, null,
				null, null, null, null, null, false);
		if (!os.isEmpty()) {
			return os.get(0);
		}
		return null;
	}

	private Obs createObs(Obs blueprint) {
		if (blueprint == null) {
			return null;
		}
		Obs o = new Obs();
		o.setChangedBy(blueprint.getChangedBy());
		o.setCreator(blueprint.getCreator());
		o.setDateChanged(blueprint.getDateChanged());
		o.setDateCreated(blueprint.getDateCreated());
		o.setLocation(blueprint.getLocation());
		o.setObsDatetime(blueprint.getObsDatetime());
		o.setPerson(blueprint.getPerson());

		o.setConcept(blueprint.getConcept());
		o.setValueCoded(blueprint.getValueCoded());
		o.setValueCodedName(blueprint.getValueCodedName());
		o.setValueDatetime(blueprint.getValueDatetime());
		o.setValueNumeric(blueprint.getValueNumeric());
		o.setValueText(blueprint.getValueText());
		return o;
	}

	private Encounter createEncounter(Encounter blueprint,
			EncounterType newEncounterType) {
		Encounter e = new Encounter();
		e.setChangedBy(blueprint.getChangedBy());
		e.setCreator(blueprint.getCreator());
		e.setDateChanged(blueprint.getDateChanged());
		e.setDateCreated(blueprint.getDateCreated());
		e.setEncounterDatetime(blueprint.getEncounterDatetime());
		e.setEncounterType(newEncounterType);
		e.setLocation(blueprint.getLocation());
		e.setPatient(blueprint.getPatient());
		e.setProvider(blueprint.getProvider());
		return e;
	}
}
