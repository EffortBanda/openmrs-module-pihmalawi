<htmlform>
    <table>
        <tr>
            <td>Visit Date:</td>
            <td><encounterDate id="encounterDate" default="today" /></td>
            <td>Clinic:</td>
            <td><encounterLocation default="2" id="encounterLocation"/></td>
            <td>Provider:</td>
            <td><encounterProvider default="16576" /></td>
        </tr>
    </table>
    <hr/>
    <table>
        <tr>
            <td width="100%">
                <table border="1" cellpadding="5" width="100%">
                    <tr>
                        <td>Height: <obs conceptId="5090"/> (cm)</td>
                        <td>BP: <obs conceptId="5085" /> / <obs conceptId="5086" /> (mmHg)</td>
                        <td>CHF NYHA Classification: <obs conceptId="3139" answerConceptIds="3135,3136,3137,3138" answerLabels="I,II,III,IV" style="radio"/></td>
                        <td>Peak Flow: <obs conceptId="7925"/>, % of predicted: <obs conceptId="7926"/></td>
                    </tr>
                    <tr>
                        <td>Weight: <obs conceptId="5089"/> (kg)</td>
                        <td>Fingerstick: <obs conceptId="887"/>(mg/dl) <obs conceptId="6381" answerConceptId="6379" style="checkbox"/></td>
                        <td># of seizures in the last month: <obs conceptId="7924"/>/ month</td>
                        <td>Asthma Classification: <obs conceptId="8410" answerConceptIds="1905,8405,8406,8407,8408,8409" answerLabels="Not asthma,Intermittent,Mild persistent,Moderate persistent,Severe persistent,Severe Uncontrolled"/></td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
    <hr/>
    <table>
        <tr>
            <td align="left">Diagnosis: </td>
            <td><obs conceptId="3683" answerConceptId="5" answerLabel="Asthma" style="checkbox" /></td>
            <td><obs conceptId="3683" answerConceptId="903" answerLabel="Hypertension" style="checkbox" /></td>
            <td><obs conceptId="3683" answerConceptId="155" answerLabel="Epilepsy" style="checkbox" /></td>
            <td><obs conceptId="3683" answerConceptId="3720" answerLabel="Diabetes" style="checkbox" /></td>
            <td><obs conceptId="3683" answerConceptId="3468" answerLabel="Heart Failure" style="checkbox" /></td>
            <td><obs conceptId="3683" answerConceptId="5622" answerLabel="Other" style="checkbox" /></td>
        </tr>
    </table>
    <hr/>
    <table>
        <tr>
            <td>Hospitalized since last visit?</td><td><obs conceptId="1715" style="yes_no"/></td>
            <td style="padding-left:20px;">For NCD?</td><td><obs conceptId="8411" style="radio"/></td>
            <td style="padding-left:30px;">Preferred treatment stocked out?</td><td><obs conceptId="8412" style="radio"/></td>
        </tr>
    </table>
    <hr/>
    <table cellpadding="3">
        <tr>
            <td valign="top">Current Medications: </td>
            <td valign="top">
                <table>
                    <tr><td><b>Asthma</b></td></tr>
                    <tr><td><obs conceptId="1193" answerConceptId="798" answerLabel="Salbutamol inhaler" style="checkbox"/></td></tr>
                    <tr><td><obs conceptId="1193" answerConceptId="1240" answerLabel="Beclomethasone inhaler" style="checkbox"/></td></tr>
                </table>
            </td>
            <td>
                <table>
                    <tr><td colspan="2"><b>Hypertension</b></td></tr>
                    <tr>
                        <td><obs conceptId="1193" answerConceptId="1243" answerLabel="Hydrochlorothiazide" style="checkbox"/></td>
                        <td><obs conceptId="1193" answerConceptId="3182" answerLabel="Captopril" style="checkbox"/></td>
                    </tr>
                    <tr>
                        <td><obs conceptId="1193" answerConceptId="3187" answerLabel="Amlodipine" style="checkbox"/></td>
                        <td><obs conceptId="1193" answerConceptId="1242" answerLabel="Enalapril" style="checkbox"/></td>
                    </tr>
                    <tr>
                        <td><obs conceptId="1193" answerConceptId="250" answerLabel="Nifedipine" style="checkbox"/></td>
                        <td><obs conceptId="1193" answerConceptId="3186" answerLabel="Atenolol" style="checkbox"/></td>
                    </tr>
                    <tr>
                        <td><obs conceptId="1193" answerConceptId="3183" answerLabel="Lisinopril" style="checkbox"/></td>
                        <td><obs conceptId="1193" answerConceptId="254" answerLabel="Propanolol" style="checkbox"/></td>
                    </tr>
                </table>
            </td>
            <td valign="top">
                <table>
                    <tr><td><b>Epilepsy</b></td></tr>
                    <tr><td><obs conceptId="1193" answerConceptId="238" answerLabel="Phenobarbital" style="checkbox"/></td></tr>
                    <tr><td><obs conceptId="1193" answerConceptId="273" answerLabel="Phenytoin" style="checkbox"/></td></tr>
                    <tr><td><obs conceptId="1193" answerConceptId="920" answerLabel="Carbamazepine" style="checkbox"/></td></tr>
                </table>
            </td>
            <td valign="top">
                <table>
                    <tr><td><b>Diabetes</b></td></tr>
                    <td><obs conceptId="1193" answerConceptId="8413" answerLabel="Insulin" style="checkbox"/></td>
                    <tr><td><obs conceptId="1193" answerConceptId="4052" answerLabel="Metformin" style="checkbox"/></td></tr>
                    <tr><td><obs conceptId="1193" answerConceptId="4046" answerLabel="Glibenclamide" style="checkbox"/></td></tr>
                </table>
            </td>
            <td valign="top">
                <table>
                    <tr><td><b>Heart Failure</b></td></tr>
                    <tr><td><obs conceptId="1193" answerConceptId="99" answerLabel="Furosemide" style="checkbox"/></td></tr>
                    <tr><td><obs conceptId="1193" answerConceptId="4061" answerLabel="Spironolactone" style="checkbox"/></td></tr>
                </table>
            </td>
        </tr>
        <tr>
            <td>Medications Changed?</td>
            <td colspan="6"><obs conceptId="2432" answerConceptIds="1066,1065" answerLabels="No,Yes" style="radio"/></td>
        </tr>
    </table>
    <hr/>
    <table>
        <tr>
            <td>Next Appointment Date:</td><td><obs conceptId="5096" id="nextAppointmentDate" allowFutureDates="true"/></td>
            <td><b><obs conceptId="8398" answerConceptId="1065" answerLabel="Check if patient is High risk for lost to follow up"/> </b></td>
        </tr>
    </table>
    <table>
        <tr>
            <td valign="top">Visit fully completed:</td>
            <td>
                <obs conceptId="8082" style="radio" answerConceptIds="1065,1066,1067"/>, Comment (if not fully completed)<obs conceptId="2922"/><br/>
                The patient visit was completed and the patient received all services according to the protocol. E.g.
                <ul>
                    <li>Every vitals sign or clinic measurement was done.</li>
                    <li>All the drugs were available and given to the patient.</li>
                    <li>All clinical staff was present (Nurse and Clinical Officer).</li>
                    <li>An appointment date was given to the patient.</li>
                </ul>
            </td>
        </tr>
    </table>
    <submit/>
    <script src="/openmrs/moduleResources/pihmalawi/htmlform_common.js" type="text/javascript"></script>
    <script type="text/javascript">

        var validateForm = function () {
            var isValid = false;
            isValid = validateNextAppointmentDate();
            if ( isValid ){
                isValid = validateEncounterLocation();
            }

            if (isValid) {
                $j('.submitButton').removeAttr('disabled');
                $j('.submitButton').removeClass('disabled');
                $j('div.error').text("");
                $j('div.error').hide();
            } else {
                $j('.submitButton').attr('disabled', 'disabled');
                $j('.submitButton').addClass('disabled');
            }
        };

        $j(function() {

            $j(document).keydown(function(event) {
                if (event.keyCode == 13) {
                    console.log("ENTER key has been pressed");
                    validateForm();
                    var disabled = $j('.submitButton').attr('disabled');
                    if (!disabled) {
                        $j('.submitButton').click();
                    }
                }
            });

            getField('encounterLocation.value').change(function() {
                if ( validateEncounterLocation() ) {
                    getField('encounterLocation.error').html("").hide();
                } else {
                    getField('encounterLocation.error').html("Please select a valid Location").show();
                }
            });

            getField('nextAppointmentDate.value').change(function() {
                validateNextAppointmentDate();
            });

            getField('nextAppointmentDate.value').attr( 'autocomplete' , 'off' );

            if(!document.getElementById("xmlData")) {
                if (getHttpGetParam('mode') != "EDIT") {
                    // only show for new encounters
                    var presentTime = new Date();
                    getField('nextAppointmentDate.value').datepicker('option', 'minDate', new Date());
                    var sixMonthsFromNow = new Date(presentTime.setMonth(presentTime.getMonth()+6));
                    getField('nextAppointmentDate.value').datepicker('option', 'maxDate', sixMonthsFromNow);
                    checkEnGbLocale("<lookup expression="locale" />");
                }
            }

            $j(document).change(validateForm);
            $j(document).click(validateForm);


        });

    </script>
</htmlform>