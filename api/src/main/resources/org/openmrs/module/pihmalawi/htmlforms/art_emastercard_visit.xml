<htmlform>
    <table>
        <tr>
            <!-- Provider is close to useless for us, so just hide it -->
            <td style="display:none">Provider</td>
            <td style="display:none">
                <encounterProvider default="16576"/>
            </td>
            <td>Clinic</td>
            <td>
                <encounterLocation id="encounterLocation"/>
            </td>
            <td>
                Current Outcome
            </td>
            <td>
                '<lookup expression="fn.currentProgramWorkflowStatus(1).getState().getConcept().getName().getName()" />'
                (since <lookup expression="fn.currentProgramWorkflowStatus(1).getStartDate()" />)
            </td>
        </tr>
    </table>
    <table>
        <tr>
            <td>Visit Date</td>

            <td>Height</td>
            <td>Weight</td>
            <td>ART Regimen</td>
            <td>Side Effects</td>
            <td>TB Status</td>
            <td>Pill Count</td>
            <td>Doses Missed</td>
            <td colspan="2" align="center">
                ARVs given
                <table>
                    <tr>
                        <td># tablets</td>
                        <td>To</td>
                    </tr>
                </table>
            </td>
            <td>CPT # tablets</td>
            <td>Viral Load Sample</td>
            <td>Viral load</td>
            <td colspan="2" align="center">
                Family Plan.
                <table>
                    <tr>
                        <td>Depo given</td>
                        <td># cndms</td>
                    </tr>
                </table>
            </td>

            <td>Next appointment</td>

        </tr>
        <tr>
            <td>
                <!-- Visit date -->
                <encounterDate id="encounterDate" default="today" />
            </td>



            <td>
                <!-- Height -->
                <obs conceptId="5090" id="heightInput" />
            </td>
            <td>
                <!-- Weight -->
                <obs conceptId="5089" id="weightInput" />
            </td>
            <td>
                <!-- ART Regimen -->
                <obs conceptId="8169" answerConceptIds="8155,8157,8159,8162,8164,8165,8166,8167,8156,8158,8160,8163,8168,6408"/>
            </td>
            <td>
                <!-- Side Effects -->
                <obs conceptId="7755" style="checkbox" answerConceptId="1066"
                     answerLabel="No" />
                <obs conceptId="7755" style="checkbox" answerConceptId="821"
                     answerLabel="PN" />
                <obs conceptId="7755" style="checkbox" answerConceptId="29"
                     answerLabel="HP" />
                <obs conceptId="7755" style="checkbox" answerConceptId="512"
                     answerLabel="SK" />
                <obs conceptId="7755" style="checkbox" answerConceptId="2148"
                     answerLabel="Lip" />
                <obs conceptId="7755" style="checkbox" answerConceptId="6408"
                     answerLabel="Oth" />
            </td>
            <td>
                <!-- TB Status -->
                <obs conceptId="7459" style="radio" answerConceptIds="7454,7455,7456,7458"
                     answerLabels="N,Y,C,Rx" />
            </td>
            <td>
                <!-- Pill count -->
                <obs conceptId="2540" />
            </td>
            <td>
                <!-- Doses missed -->
                <obs conceptId="2973" />
            </td>
            <td>
                <!-- # ARVs -->
                <obs conceptId="2929" />
            </td>
            <td style="white-space: nowrap;">
                <!-- # ARVs given to -->
                <obs conceptId="2122" style="no_yes" noLabel="P" yesLabel="G" />
            </td>
            <td>
                <!-- CPT # tablets -->
                <obs conceptId="6319"/>
            </td>
            <!-- Viral load sample -->
            <td><obs conceptId="8421" style="checkbox" answerConceptId="8421" answerLabel="Bled" /></td>
            <td>
                <!-- Viral load -->
                <obs conceptId="856"/>
            </td>
            <td>
                <!-- depo given -->
                <obs conceptId="8029" style="checkbox" answerConceptId="1065"
                     answerLabel="" />
            </td>
            <td>
                <!-- # condoms -->
                <obs conceptId="8080"/>
            </td>

            <td>
                <!-- Next appointment -->
                <obs conceptId="5096" id="nextAppointmentDate" allowFutureDates="true" />
            </td>
        </tr>
        <tr>
            <td colspan="14" align="left">
                <submit />
            </td>
        </tr>
    </table>
    <script src="/openmrs/moduleResources/pihmalawi/htmlform_common.js" type="text/javascript"></script>
    <script type="text/javascript">

        var ENTER_KEY = 13;
        var TAB_KEY = 9;

        beforeSubmit.push( function(){
        return validateForm();
        });

        var validateForm = function () {
        var isValid = false;
        isValid = validateNextAppointmentDate();
        if ( isValid ){
        isValid = validateEncounterLocation();
        }

        if (isValid) {
        $j('.submitButton').removeAttr('disabled');
        $j('.submitButton').removeClass('disabled');
        $j('div.error').text("");
        $j('div.error').hide();
        } else {
        $j('.submitButton').attr('disabled', 'disabled');
        $j('.submitButton').addClass('disabled');
        }
        return isValid;
        };

        $j(function() {

        validateForm();

        $j(document).keydown(function(event) {
        if (event.keyCode == ENTER_KEY) {
        validateForm();
        var disabled = $j('.submitButton').attr('disabled');
        if (!disabled) {
        $j('.submitButton').click();
        }
        }
        });

        getField('encounterLocation.value').change(function() {
        if ( validateEncounterLocation() ) {
        getField('encounterLocation.error').html("").hide();
        } else {
        getField('encounterLocation.error').html("Please select a valid Location").show();
        }

        });

        getField('encounterLocation.value').keydown(function(event) {
        if (event.keyCode == TAB_KEY) {
        getField('encounterDate.value').focus();
        }
        });

        getField('encounterDate.value').change(function() {
        console.log("encounterDate.value changed");
        getField('encounterDate.value').focus();

        });

        getField('encounterDate.value').keydown(function(event) {

        if (event.keyCode == TAB_KEY) {
        console.log("encounterDate.value keydown: " + event.keyCode);
        // getField('heightInput.value').focus();
        }
        });


        getField('nextAppointmentDate.value').change(function() {
        validateNextAppointmentDate();
        });

        getField('nextAppointmentDate.value').attr( 'autocomplete' , 'off' );

        if(!document.getElementById("xmlData")) {
        if (getHttpGetParam('mode') != "EDIT") {
        // only show for new encounters
        setEncounterLocation(getElement('w3'), "<lookup expression="patient.getAttribute(7)"/>");
        var presentTime = new Date();
        getField('nextAppointmentDate.value').datepicker('option', 'minDate', new Date());
        var sixMonthsFromNow = new Date(presentTime.setMonth(presentTime.getMonth()+6));
        getField('nextAppointmentDate.value').datepicker('option', 'maxDate', sixMonthsFromNow);
        checkEnGbLocale("<lookup expression="locale"/>");
        }
        }


        $j(document).change(validateForm);

        });


    </script>
</htmlform>